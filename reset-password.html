<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Şifre Sıfırla — Promptio</title>

  <style>
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:#070B12;
      color:#fff;
    }
    .card{
      width:100%;
      max-width:420px;
      background:#0B1220;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:24px;
      box-shadow:0 30px 80px rgba(0,0,0,.6);
    }
    h1{margin:0 0 12px;font-size:22px}
    p{margin:0 0 18px;color:rgba(255,255,255,.75);font-size:14px}
    input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.2);
      background:#05080f;
      color:#fff;
      font-size:14px;
      margin-bottom:12px;
      outline:none;
    }
    button{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:none;
      background:linear-gradient(135deg,#2DA8FF,#FF6A2A);
      color:#000;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition: opacity .15s ease;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .msg{
      margin-top:12px;
      font-size:13px;
      color:rgba(255,255,255,.85);
      word-break: break-word;
    }
    .hint{
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,.60);
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Şifreyi sıfırla</h1>
    <p>Yeni şifreni belirle.</p>

    <input id="password" type="password" placeholder="Yeni şifre" autocomplete="new-password" />
    <input id="password2" type="password" placeholder="Yeni şifre (tekrar)" autocomplete="new-password" />

    <button id="btn" disabled>Şifreyi Güncelle</button>
    <div class="msg" id="msg">Hazırlanıyor...</div>
    <div class="hint" id="hint"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ✅ CDN global'i: window.supabase
    const SUPABASE_URL = "https://pdcrdlnraaiqvrpewiyz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkY3JkbG5yYWFpcXZycGV3aXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTk2ODYsImV4cCI6MjA4MDA3NTY4Nn0.zoKk6Dh9GyLSpBgYETy0Xh5BZj_ivXOzkKyy04ySf2k";

    const { createClient } = window.supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        detectSessionInUrl: true, // hash içindeki tokenları yakalamaya çalışır
      }
    });

    const elP1 = document.getElementById("password");
    const elP2 = document.getElementById("password2");
    const elBtn = document.getElementById("btn");
    const elMsg = document.getElementById("msg");
    const elHint = document.getElementById("hint");

    let hasRecoverySession = false;

    function setMsg(t){ elMsg.textContent = t; }
    function setHint(t){ elHint.textContent = t || ""; }

    function validateInputs(){
      const p1 = (elP1.value || "").trim();
      const p2 = (elP2.value || "").trim();

      if(!hasRecoverySession){
        elBtn.disabled = true;
        return;
      }
      if(!p1 || p1.length < 6){
        elBtn.disabled = true;
        return;
      }
      if(p1 !== p2){
        elBtn.disabled = true;
        return;
      }
      elBtn.disabled = false;
    }

    function parseHashParams(){
      const hash = (window.location.hash || "").replace(/^#/, "");
      const params = new URLSearchParams(hash);
      return {
        access_token: params.get("access_token"),
        refresh_token: params.get("refresh_token"),
        type: params.get("type"),
        error: params.get("error"),
        error_description: params.get("error_description"),
      };
    }

    async function ensureRecoverySession(){
      // 1) Hash’ten access/refresh token geldiyse setSession yap
      const hp = parseHashParams();
      if(hp.error){
        setMsg("Hata: " + (hp.error_description || hp.error));
        setHint("Link süresi dolmuş olabilir. Yeniden şifre sıfırlama maili iste.");
        hasRecoverySession = false;
        validateInputs();
        return;
      }

      if(hp.access_token && hp.refresh_token){
        setMsg("Doğrulanıyor...");
        const { error } = await supabaseClient.auth.setSession({
          access_token: hp.access_token,
          refresh_token: hp.refresh_token,
        });
        if(error){
          setMsg("Hata: " + error.message);
          setHint("Link süresi dolmuş olabilir. Yeniden mail iste.");
          hasRecoverySession = false;
        }else{
          hasRecoverySession = true;
          setMsg("✅ Link doğrulandı. Yeni şifreni gir.");
          setHint("");
        }
        validateInputs();
        return;
      }

      // 2) Bazı projelerde link "code" ile gelir (PKCE). Varsa exchange et.
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if(code){
        setMsg("Doğrulanıyor...");
        const { error } = await supabaseClient.auth.exchangeCodeForSession(code);
        if(error){
          setMsg("Hata: " + error.message);
          setHint("Link süresi dolmuş olabilir. Yeniden mail iste.");
          hasRecoverySession = false;
        }else{
          hasRecoverySession = true;
          setMsg("✅ Link doğrulandı. Yeni şifreni gir.");
          setHint("");
        }
        validateInputs();
        return;
      }

      // 3) Hiç token yoksa: sayfaya direkt girilmiş demek
      setMsg("Bu sayfa sadece şifre sıfırlama linkiyle açılmalı.");
      setHint("Maildeki 'Şifreyi Sıfırla' bağlantısına tıkla.");
      hasRecoverySession = false;
      validateInputs();
    }

    async function resetPassword(){
      const p1 = (elP1.value || "").trim();
      const p2 = (elP2.value || "").trim();

      if(!hasRecoverySession){
        setMsg("Hata: Oturum bulunamadı. Mail linkini yeniden aç.");
        return;
      }
      if(!p1 || p1.length < 6){
        setMsg("Şifre en az 6 karakter olmalı.");
        return;
      }
      if(p1 !== p2){
        setMsg("Şifreler eşleşmiyor.");
        return;
      }

      elBtn.disabled = true;
      setMsg("Güncelleniyor...");

      const { error } = await supabaseClient.auth.updateUser({ password: p1 });

      if(error){
        setMsg("Hata: " + error.message);
        setHint("Link süresi dolmuş olabilir. Yeniden mail iste.");
        validateInputs();
      }else{
        setMsg("✅ Şifre güncellendi. Uygulamaya dönebilirsin.");
        setHint("");
      }
    }

    elP1.addEventListener("input", validateInputs);
    elP2.addEventListener("input", validateInputs);
    elBtn.addEventListener("click", resetPassword);

    // Başlat
    ensureRecoverySession();
  </script>
</body>
</html>
